# NewsDigest Docker Compose Configuration
# Usage: docker-compose up -d

version: "3.8"

services:
  # ===========================================================================
  # CLI Tool - Run extraction commands
  # ===========================================================================
  newsdigest:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: runtime
    image: newsdigest:latest
    container_name: newsdigest-cli
    volumes:
      - newsdigest-data:/data
      - ./config:/config:ro
    environment:
      - NEWSDIGEST_CONFIG=/config/config.yml
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    env_file:
      - ../.env
    # Override entrypoint for interactive use
    entrypoint: ["python", "-m", "newsdigest"]
    # Default command shows help; override with: docker-compose run newsdigest extract <url>
    command: ["--help"]

  # ===========================================================================
  # API Server - REST API for integrations
  # ===========================================================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: api
    image: newsdigest-api:latest
    container_name: newsdigest-api
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      - newsdigest-data:/data
      - ./config:/config:ro
    environment:
      - NEWSDIGEST_CONFIG=/config/config.yml
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - API_HOST=0.0.0.0
      - API_PORT=8080
    env_file:
      - ../.env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Watch Mode - Continuous monitoring
  # ===========================================================================
  watcher:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: runtime
    image: newsdigest:latest
    container_name: newsdigest-watcher
    volumes:
      - newsdigest-data:/data
      - ./config:/config:ro
      - ./output:/output
    environment:
      - NEWSDIGEST_CONFIG=/config/config.yml
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    env_file:
      - ../.env
    entrypoint: ["python", "-m", "newsdigest"]
    command: ["watch", "--sources", "/config/sources.yml", "--output", "/output"]
    restart: unless-stopped
    profiles:
      - watch  # Only start with: docker-compose --profile watch up

  # ===========================================================================
  # Redis Cache (optional - for production API)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: newsdigest-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    profiles:
      - production

# =============================================================================
# Volumes
# =============================================================================
volumes:
  newsdigest-data:
    driver: local
  redis-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: newsdigest-network
